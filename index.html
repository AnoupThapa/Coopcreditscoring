<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Cooperative Credit Scoring System - Nepal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f3f4f6;
            --border: #d1d5db;
            --text: #1f2937;
            --nepali-red: #DC143C;
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, #312e81 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }

        .config-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border-left: 5px solid var(--nepali-red);
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .section-title {
            font-size: 1.4em;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bilingual-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text);
        }

        .nepali-text {
            font-family: 'Kalimati', 'Noto Sans Devanagari', sans-serif;
            color: var(--nepali-red);
            font-size: 0.95em;
            margin-top: 2px;
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-hint {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 4px;
        }

        .conditional-field {
            background: #fef3c7;
            border: 2px dashed #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .conditional-field.model-b {
            background: #dbeafe;
            border-color: var(--secondary);
        }

        .conditional-field.existing {
            background: #d1fae5;
            border-color: var(--success);
        }

        .hidden {
            display: none !important;
        }

        .calculate-btn {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            border: none;
            padding: 16px 45px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin: 40px auto;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(5, 150, 105, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .results-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            margin-top: 30px;
            border-top: 5px solid var(--success);
        }

        .results-panel.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .score-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--light);
        }

        .total-score {
            font-size: 4em;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin: 20px 0;
        }

        .score-badge {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            margin-top: 10px;
        }

        .score-excellent { background: var(--success); }
        .score-good { background: #2563eb; }
        .score-average { background: var(--warning); }
        .score-poor { background: var(--danger); }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--secondary);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .metric-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95em;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: 800;
            color: var(--text);
        }

        .score-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .score-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .score-fill.medium { background: var(--warning); }
        .score-fill.low { background: var(--danger); }

        .weight-info {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 5px;
        }

        .toggle-fields {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-card {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .radio-card:hover {
            border-color: var(--secondary);
            background: #f0f9ff;
        }

        .radio-card.selected {
            border-color: var(--primary);
            background: #eff6ff;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.1);
        }

        .radio-card input {
            display: none;
        }

        .alert {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .alert-info {
            background: #dbeafe;
            border-color: var(--secondary);
        }

        .section-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--light);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* New Synopsis Styles */
        .synopsis-container {
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .synopsis-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .synopsis-title {
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .risk-profile {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .risk-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .analysis-card.critical { border-left-color: var(--danger); }
        .analysis-card.warning { border-left-color: var(--warning); }
        .analysis-card.good { border-left-color: var(--success); }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .analysis-category {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
        }

        .analysis-score {
            font-size: 1.5em;
            font-weight: 800;
        }

        .analysis-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-excellent { background: #d1fae5; color: #065f46; }
        .status-good { background: #dbeafe; color: #1e40af; }
        .status-moderate { background: #fef3c7; color: #92400e; }
        .status-poor { background: #fee2e2; color: #991b1b; }

        .analysis-details {
            font-size: 0.95em;
            color: #4b5563;
            line-height: 1.6;
        }

        .decision-matrix {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #bfdbfe;
        }

        .decision-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .decision-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .decision-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .decision-label {
            font-weight: 700;
            color: #374151;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .decision-value {
            color: #1f2937;
            font-size: 1.1em;
        }

        .strength-weakness {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .sw-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .sw-title {
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .strengths .sw-title { color: var(--success); border-color: var(--success); }
        .weaknesses .sw-title { color: var(--danger); border-color: var(--danger); }

        .sw-list {
            list-style: none;
        }

        .sw-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .sw-list li:before {
            content: '';
            position: absolute;
            left: 0;
            top: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .strengths .sw-list li:before { background: var(--success); }
        .weaknesses .sw-list li:before { background: var(--danger); }

        @media (max-width: 768px) {
            .config-row,
            .form-grid,
            .chart-grid,
            .strength-weakness {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .total-score {
                font-size: 3em;
            }
        }

        .print-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
            margin-top: -10px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .benchmark-bar {
            background: #f3f4f6;
            height: 30px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }

        .benchmark-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.9em;
        }

        .benchmark-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
<base target="_blank">
</head>
<body>

<div class="container">
    <header>
        <h1>üèõÔ∏è Dairy Cooperative Credit Scoring System</h1>
        <div class="subtitle">Nepal Agricultural Finance & Cooperative Risk Assessment Platform</div>
    </header>

    <!-- Configuration Panel -->
    <div class="config-panel">
        <h2 style="margin-bottom: 15px; color: var(--primary);">Application Configuration</h2>
        <div class="config-row">
            <div>
                <label class="bilingual-label">
                    Cooperative Model Type
                    <span class="nepali-text">‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä ‡§Æ‡•ã‡§°‡§≤‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</span>
                </label>
                <div class="toggle-fields">
                    <label class="radio-card" onclick="setCoopType('collection')">
                        <input type="radio" name="coop_type" value="collection" id="type_collection">
                        <div>
                            <strong>Collection Only</strong><br>
                            <small style="color: #6b7280;">‡§¶‡•Ç‡§ß ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® ‡§Æ‡§æ‡§§‡•ç‡§∞</small>
                        </div>
                    </label>
                    <label class="radio-card" onclick="setCoopType('processing')">
                        <input type="radio" name="coop_type" value="processing" id="type_processing">
                        <div>
                            <strong>Collection & Processing</strong><br>
                            <small style="color: #6b7280;">‡§∏‡§ô‡•ç‡§ï‡§≤‡§® ‡§∞ ‡§™‡•ç‡§∞‡§∂‡•ã‡§ß‡§®</small>
                        </div>
                    </label>
                </div>
            </div>

            <div>
                <label class="bilingual-label">
                    Customer Status
                    <span class="nepali-text">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</span>
                </label>
                <div class="toggle-fields">
                    <label class="radio-card" onclick="setCustomerType('new')">
                        <input type="radio" name="customer_type" value="new" id="cust_new">
                        <div>
                            <strong>New Customer</strong><br>
                            <small style="color: #6b7280;">‡§®‡§Ø‡§æ‡§Å ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</small>
                        </div>
                    </label>
                    <label class="radio-card" onclick="setCustomerType('existing')">
                        <input type="radio" name="customer_type" value="existing" id="cust_existing">
                        <div>
                            <strong>Existing Customer</strong><br>
                            <small style="color: #6b7280;">‡§™‡•Å‡§∞‡§æ‡§®‡•ã ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</small>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="config_alert" class="alert hidden" style="margin-top: 15px;">
            Please select both Cooperative Type and Customer Status to proceed.
        </div>
    </div>

    <!-- Navigation -->
    <div class="section-nav" id="section_nav" style="display: none;">
        <button class="nav-btn active" onclick="showTab('basic')">Basic Info</button>
        <button class="nav-btn" onclick="showTab('financial')">Financial</button>
        <button class="nav-btn" onclick="showTab('milk')">Milk Metrics</button>
        <button class="nav-btn" onclick="showTab('operations')">Operations</button>
        <button class="nav-btn" onclick="showTab('management')">Management</button>
        <button class="nav-btn" onclick="showTab('farmers')">Farmers</button>
        <button class="nav-btn" onclick="showTab('declaration')">Declarations</button>
        <button class="nav-btn hidden" id="nav_credit" onclick="showTab('credit')">Credit History</button>
    </div>

    <form id="scoringForm" onsubmit="event.preventDefault(); calculateScores();">
        
        <!-- Sections remain the same as previous version -->
        <!-- [Previous form sections remain unchanged...] -->
        
        <!-- Section 1: Basic Information -->
        <div class="form-section active" id="section_basic">
            <div class="section-header">
                <div class="section-title">
                    üè¢ Cooperative Information
                    <span class="section-badge">Section 1</span>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Cooperative Name / ‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ
                    </label>
                    <input type="text" id="coop_name" required placeholder="e.g., Laxmi Milk Coop">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Model Type / ‡§Æ‡•ã‡§°‡§≤‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞
                    </label>
                    <select id="model_type" disabled>
                        <option value="">-- Select Above --</option>
                        <option value="Collection">Collection Only</option>
                        <option value="Processing">Collection & Processing</option>
                    </select>
                    <div class="input-hint">Auto-filled from configuration</div>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Proposed Loan Amount (NPR) / ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§ã‡§£ ‡§∞‡§ï‡§Æ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="loan_proposed" min="0" required placeholder="e.g., 3000000">
                </div>
            </div>
        </div>

        <!-- Section 2: Financial Metrics -->
        <div class="form-section" id="section_financial">
            <div class="section-header">
                <div class="section-title">
                    üí∞ Loan & Financial Metrics
                    <span class="section-badge">Section 2</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Existing Loan Amount (NPR) / ‡§π‡§æ‡§≤ ‡§ö‡§≤‡§ø‡§∞‡§π‡•á‡§ï‡•ã ‡§ã‡§£ ‡§∞‡§ï‡§Æ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="loan_existing" min="0" placeholder="e.g., 5000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Revenue (NPR) / ‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (‡§∞‡•Å)
                    </label>
                    <input type="number" id="revenue_total" min="0" required placeholder="e.g., 35000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        EBITDA (NPR) / ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§®‡§æ‡§´‡§æ/‡§Æ‡•Å‡§®‡§æ‡§´‡§æ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="ebitda" required placeholder="e.g., 2000000">
                    <div class="input-hint">Operating Income</div>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Principal Repayment (NPR) / ‡§∏‡§æ‡§Å‡§µ‡§æ ‡§≠‡•Å‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§∞‡§ï‡§Æ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="repayment_principal" min="0" required placeholder="e.g., 1000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Interest Payment (NPR) / ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ñ‡§∞‡•ç‡§ö (‡§∞‡•Å)
                    </label>
                    <input type="number" id="repayment_interest" min="0" required placeholder="e.g., 250000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Assets (NPR) /  ‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§∏‡§Æ‡•ç‡§™‡§§‡•ç‡§§‡§ø‡§§‡§ø (‡§∞‡•Å)
                    </label>
                    <input type="number" id="assets_total" min="0" required placeholder="e.g., 15000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Liabilities (NPR) /  ‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="liabilities_total" min="0" required placeholder="e.g., 9000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Current Assets (NPR) / ‡§ö‡§æ‡§≤‡•Å ‡§∏‡§Æ‡•ç‡§™‡§§‡•ç‡§§‡§ø (‡§∞‡•Å)
                    </label>
                    <input type="number" id="assets_current" min="0" required placeholder="e.g., 5000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Current Liabilities (NPR) / ‡§ö‡§æ‡§≤‡•Å ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="liabilities_current" min="0" required placeholder="e.g., 2800000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Debt (NPR) / ‡§ï‡•Å‡§≤ ‡§ã‡§£ ‡§§‡§•‡§æ ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="debt_total" min="0" required placeholder="e.g., 9000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Equity (NPR) /  ‡§™‡•Ç‡§Å‡§ú‡•Ä ‡§ï‡•ã‡§∑ / ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (‡§∞‡•Å)
                    </label>
                    <input type="number" id="equity" min="0" required placeholder="e.g., 6000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Grant Income (NPR) / ‡§Ö‡§®‡•Å‡§¶‡§æ‡§® ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (‡§∞‡•Å)
                    </label>
                    <input type="number" id="income_grant" min="0" placeholder="e.g., 200000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Operating Expenses (NPR) / ‡§ï‡•Å‡§≤ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ñ‡§∞‡•ç‡§ö (‡§∞‡•Å)
                    </label>
                    <input type="number" id="expenses_operating" min="0" required placeholder="e.g., 10000000">
                    <div class="input-hint">Exclude depreciation & non-operating items</div>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Average Inventory (NPR) / ‡§î‡§∏‡§§ ‡§Æ‡•å‡§ú‡•ç‡§¶‡§æ‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="inventory_avg" min="0" placeholder="e.g., 1000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        COGS (NPR) / ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§µ‡§∏‡•ç‡§§‡•Å‡§ï‡•ã ‡§≤‡§æ‡§ó‡§§¬† (‡§∞‡•Å)
                    </label>
                    <input type="number" id="cogs" min="0" required placeholder="e.g., 28000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Accounts Receivable (NPR) / ‡§≤‡§ø‡§® ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§∞‡§ï‡§Æ/‡§™‡§æ‡§â‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="ar_total" min="0" placeholder="e.g., 2500000">
                </div>
            </div>
        </div>

        <!-- Section 3: Milk Metrics -->
        <div class="form-section" id="section_milk">
            <div class="section-header">
                <div class="section-title">
                    ü•õ Milk Supply & Operations
                    <span class="section-badge">Section 3</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Avg Monthly Milk (Liters) / ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§î‡§∏‡§§ ‡§¶‡•Ç‡§ß ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® (‡§≤‡§ø‡§ü‡§∞)
                    </label>
                    <input type="number" id="milk_monthly_avg" min="0" required placeholder="e.g., 50000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Lowest Monthly Milk (Liters) / ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® (‡§≤‡§ø‡§ü‡§∞)
                    </label>
                    <input type="number" id="milk_monthly_low" min="0" required placeholder="e.g., 40000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Milk Collected (Liters) / ‡§ï‡•Å‡§≤ ‡§¶‡•Ç‡§ß ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® (‡§≤‡§ø‡§ü‡§∞)
                    </label>
                    <input type="number" id="milk_total" min="0" required placeholder="e.g., 600000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Milk Loss (Liters) / ‡§¨‡§ø‡§ó‡•ç‡§∞‡§ø‡§è‡§ï‡•ã / ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§®‡•Ä ‡§≠‡§è‡§ï‡•ã ‡§¶‡•Ç‡§ß (‡§≤‡§ø‡§ü‡§∞)
                    </label>
                    <input type="number" id="milk_loss" min="0" placeholder="e.g., 75000">
                </div>

                <!-- Model B Only Fields -->
                <div class="form-group model-b-field hidden">
                    <label class="bilingual-label">
                        Produced Milk (Liters) [Model B] / ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¶‡•Ç‡§ß (‡§≤‡§ø‡§ü‡§∞)
                    </label>
                    <input type="number" id="milk_produced" min="0" placeholder="e.g., 550000">
                    <div class="input-hint" style="color: var(--secondary);">Required for Collection & Processing model</div>
                </div>

                <div class="form-group model-b-field hidden">
                    <label class="bilingual-label">
                        Sold Products Value (NPR) [Model B] / ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä‡•ã ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§∞‡•Å)
                    </label>
                    <input type="number" id="sales_products" min="0" placeholder="e.g., 9000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Lean Month Expenses (NPR) / ‡§î‡§∏‡§§ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ñ‡§∞‡•ç‡§ö(‡§∞‡•Å)
                    </label>
                    <input type="number" id="expenses_lean" min="0" required placeholder="e.g., 1041666">
                    <div class="input-hint">Monthly expenses during low season</div>
                </div>
            </div>
        </div>

        <!-- Section 4: Operations & Recovery -->
        <div class="form-section" id="section_operations">
            <div class="section-header">
                <div class="section-title">
                    üîÑ Loan Recovery & Collateral
                    <span class="section-badge">Section 4</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Total Member Loans (NPR) /  ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ã‡§£ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•Å‡§≤(‡§∞‡•Å)
                    </label>
                    <input type="number" id="loans_members_total" min="0" required placeholder="e.g., 5000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        NPA Member Loans (NPR) / ‡§ñ‡§∞‡§æ‡§¨ / ‡§Ö‡§∏‡•Å‡§≤ ‡§π‡•Å‡§® ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§ã‡§£ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="loans_npa" min="0" placeholder="e.g., 200000">
                    <div class="input-hint">Non-performing assets / overdue loans</div>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Recovery via Milk Deduction (NPR) / ‡§¶‡•Ç‡§ß ‡§ï‡§ü‡•å‡§§‡•Ä‡§Æ‡§æ‡§∞‡•ç‡§´‡§§ ‡§Ö‡§∏‡•Å‡§≤ ‡§≠‡§è‡§ï‡•ã ‡§∞‡§ï‡§Æ (‡§∞‡•Å)
                    </label>
                    <input type="number" id="recovery_milk" min="0" placeholder="e.g., 4700000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Primary Collateral Value (NPR) / ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ß‡§ø‡§§‡•ã‡§ï‡•ã ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§∞‡•Å)
                    </label>
                    <input type="number" id="collateral_primary" min="0" required placeholder="e.g., 5000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Secondary Collateral Value (NPR) / ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§/‡§∏‡§π‡§æ‡§Ø‡§ï ‡§ß‡§ø‡§§‡•ã‡§ï‡•ã ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§∞‡•Å)
                    </label>
                    <input type="number" id="collateral_secondary" min="0" placeholder="e.g., 5000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Bank Sales (NPR) / ‡§¨‡•à‡§Ç‡§ï‡§Æ‡§æ‡§∞‡•ç‡§´‡§§ ‡§≠‡§è‡§ï‡•ã ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§∞‡•Å)
                    </label>
                    <input type="number" id="sales_bank" min="0" required placeholder="e.g., 25000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Sales (NPR) / ‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (‡§∞‡•Å)
                    </label>
                    <input type="number" id="sales_total" min="0" required placeholder="e.g., 30000000">
                </div>
            </div>
        </div>

        <!-- Section 5: Management -->
        <div class="form-section" id="section_management">
            <div class="section-header">
                <div class="section-title">
                    üë• Management & Governance
                    <span class="section-badge">Section 5</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Key Management Experience (Avg Years) / ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§ï‡•ã ‡§î‡§∏‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ (‡§µ‡§∞‡•ç‡§∑)
                    </label>
                    <input type="number" id="mgmt_experience" min="0" max="50" required placeholder="e.g., 8">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Internal Controls Score / ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§®‡§ø‡§Ø‡§®‡•ç‡§§‡•ç‡§∞‡§£ ‡§∏‡•ç‡§ï‡•ã‡§∞
                    </label>
                    <select id="internal_controls" required>
                        <option value="">Select</option>
                        <option value="robust">Robust - ‡§Æ‡§ú‡§¨‡•Å‡§§</option>
                        <option value="adequate">Adequate - ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§</option>
                        <option value="weak">Weak - ‡§ï‡§Æ‡§ú‡•ã‡§∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Audit Findings / ‡§Ö‡§°‡§ø‡§ü‡§Æ‡§æ ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡§æ ‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ
                    </label>
                    <select id="audit_findings" required>
                        <option value="">Select</option>
                        <option value="none">None - ‡§ï‡•Å‡§®‡•à ‡§õ‡•à‡§®</option>
                        <option value="few">Few - ‡§ï‡•á‡§π‡•Ä</option>
                        <option value="many">Many - ‡§ß‡•á‡§∞‡•à</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Lending Policy Compliance / ‡§ã‡§£ ‡§®‡•Ä‡§§‡§ø‡§ï‡•ã ‡§™‡§æ‡§≤‡§®‡§æ
                    </label>
                    <select id="lending_compliance" required>
                        <option value="">Select</option>
                        <option value="yes">Yes - ‡§õ</option>
                        <option value="partial">Partial - ‡§Ü‡§Ç‡§∂‡§ø‡§ï</option>
                        <option value="no">No - ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Collection Average / ‡§¶‡•Ç‡§ß ‡§∏‡§ô‡•ç‡§ï‡§≤‡§®‡§ï‡§æ ‡§î‡§∏‡§§ ‡§¶‡§ø‡§®‡§π‡§∞‡•Ç
                    </label>
                    <select id="collection_avg" required>
                        <option value="">Select</option>
                        <option value="high">High - ‡§â‡§ö‡•ç‡§ö</option>
                        <option value="medium">Medium - ‡§Æ‡§ß‡•ç‡§Ø‡§Æ</option>
                        <option value="low">Low - ‡§®‡•ç‡§Ø‡•Ç‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Fleet Availability / ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® ‡§∏‡§µ‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§ß‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ
                    </label>
                    <select id="fleet_available" required>
                        <option value="yes">Yes / ‡§õ</option>
                        <option value="no">No / ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Cold Storage Availability /‡§≠‡§£‡•ç‡§°‡§æ‡§∞‡§£/‡§ö‡§ø‡§∏‡•ã ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ
                    </label>
                    <select id="storage_available" required>
                        <option value="yes">Yes / ‡§õ</option>
                        <option value="no">No / ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group model-b-field hidden">
                    <label class="bilingual-label">
                        Quality SOP Score (1-10) [Model B] / ‡§ó‡•Å‡§£‡§∏‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ (SOP) ‡§∏‡•ç‡§ï‡•ã‡§∞
                    </label>
                    <input type="number" id="quality_sop" min="0" max="10" placeholder="e.g., 7">
                    <div class="input-hint">1=Poor, 10=Excellent</div>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Limit Discipline Score (1-10) / ‡§ã‡§£ ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡§æ‡§≤‡§®‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞
                    </label>
                    <input type="number" id="limit_discipline" min="0" max="10" required placeholder="e.g., 8">
                </div>
            </div>
        </div>

        <!-- Section 6: Cash & Credit -->
        <div class="form-section" id="section_farmers">
            <div class="section-header">
                <div class="section-title">
                    üíµ Cash & Farmer Metrics
                    <span class="section-badge">Section 6</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Cash/Bank Balance Last Year (NPR) / ‡§™‡§õ‡§ø‡§≤‡•ç‡§≤‡•ã ‡•ß ‡§µ‡§∞‡•ç‡§∑ ‡§î‡§∏‡§§ ‡§®‡§ó‡§¶/‡§¨‡•à‡§Ç‡§ï ‡§Æ‡•å‡§ú‡•ç‡§¶‡§æ‡§§
                    </label>
                    <input type="number" id="cash_last_year" min="0" required placeholder="e.g., 2500000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Cash/Bank Balance Previous Year (NPR) / ‡§Ö‡§ò‡§ø‡§≤‡•ç‡§≤‡•ã ‡•ß ‡§µ‡§∞‡•ç‡§∑ ‡§î‡§∏‡§§ ‡§®‡§ó‡§¶/‡§¨‡•à‡§Ç‡§ï ‡§Æ‡•å‡§ú‡•ç‡§¶‡§æ‡§§
                    </label>
                    <input type="number" id="cash_prev_year" min="0" required placeholder="e.g., 2000000">
                </div>

                <!-- Existing Customer Only Fields -->
                <div class="form-group existing-field hidden">
                    <label class="bilingual-label">
                        Credit History / ‡§ã‡§£ ‡§á‡§§‡§ø‡§π‡§æ‡§∏
                    </label>
                    <select id="credit_history">
                        <option value="">Select</option>
                        <option value="excellent">Excellent - ‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü</option>
                        <option value="good">Good - ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã</option>
                        <option value="satisfactory">Satisfactory - ‡§∏‡§®‡•ç‡§§‡•ã‡§∑‡§ú‡§®‡§ï</option>
                        <option value="fair">Fair - ‡§î‡§∏‡§§</option>
                        <option value="poor">Poor - ‡§®‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã</option>
                    </select>
                </div>

                <div class="form-group existing-field hidden">
                    <label class="bilingual-label">
                       Member Max DPD (Days) / ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§ß‡•á‡§∞‡•à ‡§¢‡§ø‡§≤‡§æ ‡§≠‡§è‡§ï‡•ã ‡§¶‡§ø‡§®
                    </label>
                    <input type="number" id="max_dpd_days" min="0" placeholder="e.g., 5">
                    <div class="input-hint">Days Past Due</div>
                </div>

                <div class="form-group existing-field hidden">
                    <label class="bilingual-label">
                       Member Restructures (Past 3 yrs) / ‡§™‡§õ‡§ø‡§≤‡•ç‡§≤‡§æ ‡•© ‡§µ‡§∞‡•ç‡§∑‡§Æ‡§æ ‡§ã‡§£ ‡§™‡•Å‡§®‡§É‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ
                    </label>
                    <input type="number" id="restructures" min="0" placeholder="e.g., 0">
                </div>

                <hr style="grid-column: 1/-1; margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

                <div class="form-group">
                    <label class="bilingual-label">
                        Top 5 Farmer Collection (Liters) / ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡•´ ‡§ï‡§ø‡§∏‡§æ‡§®‡§¨‡§æ‡§ü ‡§Ü‡§è‡§ï‡•ã ‡§¶‡•Ç‡§ß ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ
                    </label>
                    <input type="number" id="farmers_top5" min="0" required placeholder="e.g., 120000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Farmer Collection (Liters) / ‡§∏‡§¨‡•à ‡§ï‡§ø‡§∏‡§æ‡§®‡§¨‡§æ‡§ü ‡§Ü‡§è‡§ï‡•ã ‡§ï‡•Å‡§≤ ‡§¶‡•Ç‡§ß
                    </label>
                    <input type="number" id="farmers_total_collection" min="0" required placeholder="e.g., 4000000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Highest Farmer Quantity (Liters) / ‡§è‡§ï ‡§ú‡§®‡§æ ‡§ï‡§ø‡§∏‡§æ‡§®‡§≤‡•á ‡§¨‡•á‡§ö‡•á‡§ï‡•ã ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§ß‡•á‡§∞‡•à
                    </label>
                    <input type="number" id="farmer_highest" min="0" required placeholder="e.g., 35000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Lowest Farmer Quantity (Liters) / ‡§è‡§ï ‡§ú‡§®‡§æ ‡§ï‡§ø‡§∏‡§æ‡§®‡§≤‡•á ‡§¨‡•á‡§ö‡•á‡§ï‡•ã ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§ï‡§Æ
                    </label>
                    <input type="number" id="farmer_lowest" min="0" placeholder="e.g., 10000">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Total Number of Farmers / ‡§ï‡•Å‡§≤ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ
                    </label>
                    <input type="number" id="farmers_count" min="1" required placeholder="e.g., 50">
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Days with Milk Collection > 0 / ‡§¶‡•Ç‡§ß ‡§∏‡§ô‡•ç‡§ï‡§≤‡§® ‡§≠‡§è‡§ï‡•ã ‡§¶‡§ø‡§®‡§ï‡•ã ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ
                    </label>
                    <input type="number" id="days_collection" min="0" max="365" required placeholder="e.g., 330">
                </div>
            </div>
        </div>

        <!-- Section 7: Declarations -->
        <div class="form-section" id="section_declaration">
            <div class="section-header">
                <div class="section-title">
                    üõ°Ô∏è Risk Factor Declarations
                    <span class="section-badge">Section 7</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Insurance Coverage / ‡§¨‡•Ä‡§Æ‡§æ ‡§≠‡§è‡§ï‡•ã ‡§õ
                    </label>
                    <select id="insurance" required>
                        <option value="yes">Yes / ‡§õ</option>
                        <option value="no">No / ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Digital MIS / POS / QR Adoption / ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡§ú‡§ø‡§∑‡•ç‡§ü‡§∞ / POS / QR
                    </label>
                    <select id="digital_mis" required>
                        <option value="yes">Full / ‡§™‡•Ç‡§∞‡•ç‡§£</option>
                        <option value="partial">Partial / ‡§Ü‡§Ç‡§∂‡§ø‡§ï</option>
                        <option value="no">No / ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Regulatory Compliance / ‡§¶‡§∞‡•ç‡§§‡§æ, ‡§ï‡§∞, NRB ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§ô
                    </label>
                    <select id="regulatory" required>
                        <option value="full">Full Compliance / ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ</option>
                        <option value="partial">Partial / ‡§Ü‡§Ç‡§∂‡§ø‡§ï</option>
                        <option value="none">Non-compliant / ‡§Ö‡§®‡•Å‡§™‡§æ‡§≤‡§® ‡§õ‡•à‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Climatic / Input Risk / ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å / ‡§á‡§®‡§™‡•Å‡§ü ‡§ú‡•ã‡§ñ‡§ø‡§Æ
                    </label>
                    <select id="climate_risk" required>
                        <option value="low">Low - ‡§ï‡§Æ</option>
                        <option value="medium">Medium - ‡§Æ‡§ß‡•ç‡§Ø‡§Æ</option>
                        <option value="high">High - ‡§â‡§ö‡•ç‡§ö</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 8: Credit History Extended (Existing Only) -->
        <div class="form-section existing-field hidden" id="section_credit">
            <div class="section-header">
                <div class="section-title">
                    üè¶ Banking Performance (Existing Borrower)
                    <span class="section-badge">Section 8</span>
                </div>
                <span style="color: var(--success); font-size: 0.9em;">Only for Existing Customers</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="bilingual-label">
                        Credit History (BFI Records) / ‡§ã‡§£ ‡§á‡§§‡§ø‡§π‡§æ‡§∏
                    </label>
                    <select id="credit_history_bfis">
                        <option value="">Select</option>
                        <option value="pass">Pass - ‡§™‡§æ‡§∏</option>
                        <option value="Watch List">Watch List - ‡§Æ‡§æ‡§®‡§ï</option>
                        <option value="substandard">Substandard - ‡§Ö‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§</option>
                        <option value="doubtful">Doubtful - ‡§∂‡§Ç‡§ï‡§æ‡§∏‡•ç‡§™‡§¶</option>
                        <option value="loss">Loss - ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§®</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="bilingual-label">
                        Max DPD (BFI) / ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§ß‡•á‡§∞‡•à ‡§¢‡§ø‡§≤‡§æ ‡§≠‡§è‡§ï‡•ã ‡§¶‡§ø‡§® (‡§¨‡•à‡§Ç‡§ï ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞)
                    </label>
                    <select id="max_dpd_bfi">
                        <option value="">Select</option>
                        <option value="timely">Timely - ‡§∏‡§Æ‡§Ø‡§Æ‡•à</option>
                        <option value="delay_30">1-30 days</option>
                        <option value="delay_60">31-60 days</option>
                        <option value="delay_90">60+ days</option>
                    </select>
                </div>
            </div>
        </div>

        <button type="submit" class="calculate-btn" id="calc_btn" style="display: none;">
            Calculate Credit Score / ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ó‡§£‡§®‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </button>
    </form>

    <!-- Results Panel with Synopsis -->
    <div class="results-panel" id="results_panel">
        <button class="print-btn" onclick="window.print()">Print Report</button>
        <h2 style="color: var(--primary); margin-bottom: 20px;">Credit Assessment Report</h2>
        
        <!-- Tab Navigation for Results -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showResultTab('summary')">Executive Summary</button>
            <button class="tab-btn" onclick="showResultTab('detailed')">Detailed Metrics</button>
            <button class="tab-btn" onclick="showResultTab('breakdown')">Calculation Breakdown</button>
        </div>

        <!-- Executive Summary Tab -->
        <div class="tab-content active" id="tab_summary">
            <div class="synopsis-container">
                <div class="synopsis-header">
                    <div class="synopsis-title">Executive Summary / ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</div>
                    <div style="color: #6b7280; font-size: 1.1em;">Comprehensive Risk Analysis & Decision Support</div>
                    
                    <div class="risk-profile">
                        <div class="risk-indicator" id="risk_indicator" style="background: var(--success);"></div>
                        <div style="text-align: left;">
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);" id="risk_grade">EXCELLENT</div>
                            <div style="font-size: 0.9em; color: #6b7280;">Overall Risk Rating / ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§∞‡•á‡§ü‡§ø‡§ô</div>
                        </div>
                        <div style="border-left: 2px solid #e5e7eb; padding-left: 20px; margin-left: 10px;">
                            <div class="total-score" id="summary_score" style="font-size: 2.5em; margin: 0;">0</div>
                            <div style="font-size: 0.85em; color: #6b7280;">out of 100</div>
                        </div>
                    </div>
                </div>

                <!-- Visual Charts -->
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-title">Risk Profile Radar / ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤</div>
                        <canvas id="radarChart" width="400" height="400"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Category Performance / ‡§µ‡§∞‡•ç‡§ó ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§®</div>
                        <canvas id="barChart" width="400" height="400"></canvas>
                    </div>
                </div>

                <!-- Benchmark Comparison -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e2e8f0;">
                    <div class="chart-title">Benchmark Comparison / ‡§¨‡•á‡§®‡•ç‡§ö‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§§‡•Å‡§≤‡§®‡§æ</div>
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600;">
                            <span>Your Score vs Industry Standard</span>
                            <span id="benchmark_text">Above Average</span>
                        </div>
                        <div class="benchmark-bar">
                            <div class="benchmark-fill" id="benchmark_fill" style="width: 0%; background: var(--success);">0%</div>
                        </div>
                        <div class="benchmark-labels">
                            <span>Poor (0-45)</span>
                            <span>Moderate (45-60)</span>
                            <span>Good (60-75)</span>
                            <span>Excellent (75+)</span>
                        </div>
                    </div>
                </div>

                <!-- Category Analysis Cards -->
                <div class="analysis-grid" id="category_analysis">
                    <!-- Dynamically populated -->
                </div>

                <!-- Decision Matrix -->
                <div class="decision-matrix">
                    <div class="decision-title">
                        <span>üìã</span>
                        <span>Decision Matrix / ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§Æ‡•ç‡§Ø‡§æ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏</span>
                    </div>
                    <div class="decision-grid" id="decision_grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Strengths & Weaknesses -->
                <div class="strength-weakness">
                    <div class="sw-box strengths">
                        <div class="sw-title">
                            <span>‚úì</span>
                            <span>Key Strengths / ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§≤‡§ø‡§Ø‡•ã ‡§™‡§ï‡•ç‡§∑</span>
                        </div>
                        <ul class="sw-list" id="strengths_list">
                            <!-- Dynamically populated -->
                        </ul>
                    </div>
                    <div class="sw-box weaknesses">
                        <div class="sw-title">
                            <span>‚ö†</span>
                            <span>Risk Factors / ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§ï</span>
                        </div>
                        <ul class="sw-list" id="weaknesses_list">
                            <!-- Dynamically populated -->
                        </ul>
                    </div>
                </div>

                <!-- Final Recommendation -->
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 25px; margin-top: 30px; border-left: 5px solid var(--primary);">
                    <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.3em;">Final Recommendation / ‡§Ö‡§®‡•ç‡§§‡§ø‡§Æ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏</h3>
                    <div id="final_recommendation" style="font-size: 1.1em; line-height: 1.8; color: #1f2937;">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Tab -->
        <div class="tab-content" id="tab_detailed">
            <div class="score-header">
                <div style="font-size: 1.2em; color: #6b7280; margin-bottom: 10px;">Total Weighted Score / ‡§ï‡•Å‡§≤ ‡§≠‡§æ‡§∞‡§ø‡§§ ‡§∏‡•ç‡§ï‡•ã‡§∞</div>
                <div class="total-score" id="total_score">0</div>
                <div id="score_rating" class="score-badge score-good">RATING</div>
                <div style="margin-top: 15px; font-size: 0.95em; color: #4b5563;">
                    Maximum Possible: <strong>100</strong> | Calculated for: 
                    <span id="result_coop_type">-</span> | 
                    <span id="result_cust_type">-</span>
                </div>
            </div>

            <div id="calculations_breakdown" class="metrics-grid">
                <!-- Dynamic content inserted here -->
            </div>
        </div>

        <!-- Calculation Breakdown Tab -->
        <div class="tab-content" id="tab_breakdown">
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 10px;">Calculation Methodology / ‡§ó‡§£‡§®‡§æ ‡§µ‡§ø‡§ß‡§ø</h3>
                <p style="color: #4b5563; line-height: 1.6;">
                    Scores are calculated using weighted indicators across 9 risk categories. Each indicator is normalized to a 0-5 scale, 
                    then multiplied by its respective weight. The maximum possible score is 100 points.
                </p>
            </div>
            <div id="methodology_breakdown" class="metrics-grid">
                <!-- Detailed methodology -->
            </div>
        </div>
    </div>
</div>

<script>
// State Management
let state = {
    coopType: null,
    customerType: null,
    currentTab: 'basic',
    categoryScores: {},
    finalResults: []
};

// Scoring Weights (from Model sheet)
const weights = {
    dscr: { weight: 5, maxScore: 5, name: 'DSCR', category: 'Cash Flow & Loan Repayment' },
    seasonality: { weight: 5, maxScore: 5, name: 'Seasonality Coverage', category: 'Cash Flow & Loan Repayment' },
    inventory_days: { weight: 5, maxScore: 5, name: 'Inventory Days', category: 'Cash Flow & Loan Repayment' },
    receivable_days: { weight: 5, maxScore: 5, name: 'Receivable Days', category: 'Cash Flow & Loan Repayment' },
    
    milk_stability: { weight: 3, maxScore: 5, name: 'Milk Stability %', category: 'Milk Supply & Operational Stability' },
    days_stability: { weight: 3, maxScore: 5, name: 'Days Stability %', category: 'Milk Supply & Operational Stability' },
    milk_loss: { weight: 2, maxScore: 5, name: 'Milk Loss %', category: 'Milk Supply & Operational Stability' },
    yield_loss: { weight: 2, maxScore: 5, name: 'Yield Loss % [Model B]', category: 'Milk Supply & Operational Stability' },
    farmer_concentration: { weight: 1.25, maxScore: 5, name: 'Farmer Concentration %', category: 'Milk Supply & Operational Stability' },
    collection_stability: { weight: 1.25, maxScore: 5, name: 'Collection Stability %', category: 'Milk Supply & Operational Stability' },
    payment_fairness: { weight: 1.25, maxScore: 5, name: 'Payment Fairness %', category: 'Milk Supply & Operational Stability' },
    logistics: { weight: 1.25, maxScore: 10, name: 'Logistics Reliability', category: 'Milk Supply & Operational Stability' },
    
    net_worth: { weight: 4, maxScore: 5, name: 'Net Worth', category: 'Financial Strength' },
    debt_equity: { weight: 4, maxScore: 5, name: 'Debt/Equity Ratio', category: 'Financial Strength' },
    current_ratio: { weight: 3, maxScore: 5, name: 'Current Ratio', category: 'Financial Strength' },
    grant_dependence: { weight: 2, maxScore: 5, name: 'Grant Dependence %', category: 'Financial Strength' },
    cash_trend: { weight: 2, maxScore: 5, name: 'Cash/Bank Trend', category: 'Financial Strength' },
    
    member_gnpa: { weight: 5, maxScore: 5, name: 'Member GNPA %', category: 'Loan Recovery & Member Credit Risk' },
    recovery_rate: { weight: 5, maxScore: 5, name: 'Recovery % via Milk', category: 'Loan Recovery & Member Credit Risk' },
    max_dpd: { weight: 2.5, maxScore: 5, name: 'Max DPD (Days)', category: 'Loan Recovery & Member Credit Risk' },
    restructuring: { weight: 2.5, maxScore: 5, name: 'Restructuring Count', category: 'Loan Recovery & Member Credit Risk' },
    
    mgmt_exp: { weight: 2.5, maxScore: 5, name: 'Management Experience', category: 'Management & Governance' },
    internal_controls: { weight: 2.5, maxScore: 5, name: 'Internal Controls', category: 'Management & Governance' },
    audit_findings: { weight: 2.5, maxScore: 5, name: 'Audit Findings', category: 'Management & Governance' },
    lending_compliance: { weight: 2.5, maxScore: 5, name: 'Lending Policy Compliance', category: 'Management & Governance' },
    
    quality_sop: { weight: 4, maxScore: 5, name: 'Quality SOP Score', category: 'Operational Quality' },
    limit_discipline: { weight: 2, maxScore: 5, name: 'Limit Discipline', category: 'Operational Quality' },
    bank_sales_pct: { weight: 2, maxScore: 5, name: '% Sales via Bank', category: 'Operational Quality' },
    
    primary_collateral: { weight: 5, maxScore: 5, name: 'Primary Collateral %', category: 'Collateral & Security' },
    secondary_collateral: { weight: 2, maxScore: 5, name: 'Secondary Collateral %', category: 'Collateral & Security' },
    
    insurance: { weight: 1.25, maxScore: 5, name: 'Insurance Coverage', category: 'Risk Factors' },
    digital_mis: { weight: 1.25, maxScore: 5, name: 'Digital MIS Adoption', category: 'Risk Factors' },
    regulatory: { weight: 1.25, maxScore: 5, name: 'Regulatory Compliance', category: 'Risk Factors' },
    climate_risk: { weight: 1.25, maxScore: 5, name: 'Climatic Risk', category: 'Risk Factors' },
    
    credit_history: { weight: 2.5, maxScore: 5, name: 'Credit History', category: 'Credit History' },
    max_delays: { weight: 2.5, maxScore: 5, name: 'Max Delays (BFI)', category: 'Credit History' }
};

const categoryWeights = {
    'Cash Flow & Loan Repayment': 20,
    'Milk Supply & Operational Stability': 15,
    'Financial Strength': 15,
    'Loan Recovery & Member Credit Risk': 15,
    'Management & Governance': 10,
    'Operational Quality': 8,
    'Collateral & Security': 7,
    'Risk Factors': 5,
    'Credit History': 5
};

function setCoopType(type) {
    state.coopType = type;
    document.querySelectorAll('input[name="coop_type"]').forEach(el => {
        el.closest('.radio-card').classList.remove('selected');
    });
    document.getElementById(type === 'collection' ? 'type_collection' : 'type_processing').closest('.radio-card').classList.add('selected');
    
    updateFormVisibility();
}

function setCustomerType(type) {
    state.customerType = type;
    document.querySelectorAll('input[name="customer_type"]').forEach(el => {
        el.closest('.radio-card').classList.remove('selected');
    });
    document.getElementById(type === 'new' ? 'cust_new' : 'cust_existing').closest('.radio-card').classList.add('selected');
    
    updateFormVisibility();
}

function updateFormVisibility() {
    const alert = document.getElementById('config_alert');
    
    if (!state.coopType || !state.customerType) {
        alert.classList.remove('hidden');
        return;
    }
    
    alert.classList.add('hidden');
    
    document.getElementById('section_nav').style.display = 'flex';
    document.querySelectorAll('.form-section').forEach(s => s.classList.add('active'));
    document.getElementById('calc_btn').style.display = 'block';
    
    document.getElementById('model_type').value = state.coopType === 'processing' ? 'Processing' : 'Collection';
    
    document.querySelectorAll('.model-b-field').forEach(el => {
        if (state.coopType === 'processing') {
            el.classList.remove('hidden');
            if (el.querySelector('input')) el.querySelector('input').required = true;
        } else {
            el.classList.add('hidden');
            if (el.querySelector('input')) el.querySelector('input').required = false;
        }
    });
    
    document.querySelectorAll('.existing-field').forEach(el => {
        if (state.customerType === 'existing') {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    });
    
    document.getElementById('nav_credit').classList.toggle('hidden', state.customerType !== 'existing');
    
    document.getElementById('result_coop_type').textContent = 
        state.coopType === 'processing' ? 'Collection & Processing' : 'Collection Only';
    document.getElementById('result_cust_type').textContent = 
        state.customerType === 'existing' ? 'Existing Customer' : 'New Customer';
}

function showTab(tabName) {
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById('section_' + tabName).classList.add('active');
    event.target.classList.add('active');
}

function showResultTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById('tab_' + tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'summary' && state.finalResults.length > 0) {
        drawCharts();
    }
}

// [Previous calculation functions remain the same...]
function calculateDSCR(ebitda, principal, interest) {
    const totalDebtService = principal + interest;
    return totalDebtService > 0 ? ebitda / totalDebtService : 0;
}

function getDSCRScore(dscr) {
    if (dscr >= 2.0) return 5;
    if (dscr >= 1.75) return 4;
    if (dscr >= 1.5) return 3;
    if (dscr >= 1.25) return 2;
    if (dscr >= 1.0) return 1;
    return 0;
}

function calculateScores() {
    if (!state.coopType || !state.customerType) {
        alert('Please select Cooperative Type and Customer Status first.');
        return;
    }
    
    // Gather all inputs
    const inputs = {
        revenue: parseFloat(document.getElementById('revenue_total').value) || 0,
        ebitda: parseFloat(document.getElementById('ebitda').value) || 0,
        principal: parseFloat(document.getElementById('repayment_principal').value) || 0,
        interest: parseFloat(document.getElementById('repayment_interest').value) || 0,
        assets: parseFloat(document.getElementById('assets_total').value) || 0,
        liabilities: parseFloat(document.getElementById('liabilities_total').value) || 0,
        currentAssets: parseFloat(document.getElementById('assets_current').value) || 0,
        currentLiabilities: parseFloat(document.getElementById('liabilities_current').value) || 0,
        totalDebt: parseFloat(document.getElementById('debt_total').value) || 0,
        equity: parseFloat(document.getElementById('equity').value) || 0,
        grantIncome: parseFloat(document.getElementById('income_grant').value) || 0,
        cogs: parseFloat(document.getElementById('cogs').value) || 0,
        inventory: parseFloat(document.getElementById('inventory_avg').value) || 0,
        ar: parseFloat(document.getElementById('ar_total').value) || 0,
        cashLast: parseFloat(document.getElementById('cash_last_year').value) || 0,
        cashPrev: parseFloat(document.getElementById('cash_prev_year').value) || 0,
        leanExpenses: parseFloat(document.getElementById('expenses_lean').value) || 0,
        proposedLoan: parseFloat(document.getElementById('loan_proposed').value) || 0,
        
        milkAvg: parseFloat(document.getElementById('milk_monthly_avg').value) || 0,
        milkLow: parseFloat(document.getElementById('milk_monthly_low').value) || 0,
        milkTotal: parseFloat(document.getElementById('milk_total').value) || 0,
        milkLoss: parseFloat(document.getElementById('milk_loss').value) || 0,
        milkProduced: parseFloat(document.getElementById('milk_produced')?.value) || 0,
        daysCollection: parseInt(document.getElementById('days_collection').value) || 0,
        
        top5Farmers: parseFloat(document.getElementById('farmers_top5').value) || 0,
        totalFarmerCollection: parseFloat(document.getElementById('farmers_total_collection').value) || 0,
        highestFarmer: parseFloat(document.getElementById('farmer_highest').value) || 0,
        farmerCount: parseInt(document.getElementById('farmers_count').value) || 1,
        
        memberLoans: parseFloat(document.getElementById('loans_members_total').value) || 0,
        npaLoans: parseFloat(document.getElementById('loans_npa').value) || 0,
        recoveryMilk: parseFloat(document.getElementById('recovery_milk').value) || 0,
        collateralPrimary: parseFloat(document.getElementById('collateral_primary').value) || 0,
        collateralSecondary: parseFloat(document.getElementById('collateral_secondary').value) || 0,
        
        bankSales: parseFloat(document.getElementById('sales_bank').value) || 0,
        totalSales: parseFloat(document.getElementById('sales_total').value) || 0,
        
        mgmtExp: parseInt(document.getElementById('mgmt_experience').value) || 0,
        internalControls: document.getElementById('internal_controls').value,
        auditFindings: document.getElementById('audit_findings').value,
        lendingCompliance: document.getElementById('lending_compliance').value,
        fleet: document.getElementById('fleet_available').value,
        storage: document.getElementById('storage_available').value,
        qualitySop: parseInt(document.getElementById('quality_sop')?.value) || 0,
        limitDiscipline: parseInt(document.getElementById('limit_discipline').value) || 0,
        
        maxDpd: parseInt(document.getElementById('max_dpd_days')?.value) || 0,
        restructures: parseInt(document.getElementById('restructures')?.value) || 0,
        creditHistory: document.getElementById('credit_history')?.value || 'good',
        
        insurance: document.getElementById('insurance').value,
        digital: document.getElementById('digital_mis').value,
        regulatory: document.getElementById('regulatory').value,
        climate: document.getElementById('climate_risk').value
    };
    
    // Perform Calculations
    const calculations = {};
    const scores = {};
    
    calculations.dscr = calculateDSCR(inputs.ebitda, inputs.principal, inputs.interest);
    scores.dscr = getDSCRScore(calculations.dscr);
    
    calculations.seasonality = inputs.leanExpenses > 0 ? inputs.cashLast / inputs.leanExpenses : 0;
    scores.seasonality = calculations.seasonality >= 3 ? 5 : 
                        calculations.seasonality >= 2 ? 4 :
                        calculations.seasonality >= 1.5 ? 3 :
                        calculations.seasonality >= 1 ? 2 :
                        calculations.seasonality >= 0.5 ? 1 : 0;
    
    calculations.inventory_days = inputs.cogs > 0 ? (inputs.inventory / inputs.cogs) * 365 : 0;
    scores.inventory_days = calculations.inventory_days <= 15 ? 5 :
                           calculations.inventory_days <= 30 ? 4 :
                           calculations.inventory_days <= 45 ? 3 :
                           calculations.inventory_days <= 60 ? 2 : 1;
    
    calculations.receivable_days = inputs.revenue > 0 ? (inputs.ar / inputs.revenue) * 365 : 0;
    scores.receivable_days = calculations.receivable_days <= 15 ? 5 :
                            calculations.receivable_days <= 30 ? 4 :
                            calculations.receivable_days <= 45 ? 3 :
                            calculations.receivable_days <= 60 ? 2 : 0;
    
    calculations.milk_stability = inputs.milkAvg > 0 ? (inputs.milkLow / inputs.milkAvg) * 100 : 0;
    scores.milk_stability = calculations.milk_stability >= 90 ? 5 :
                           calculations.milk_stability >= 80 ? 4 :
                           calculations.milk_stability >= 70 ? 3 :
                           calculations.milk_stability >= 60 ? 2 : 1;
    
    calculations.days_stability = (inputs.daysCollection / 365) * 100;
    scores.days_stability = calculations.days_stability >= 95 ? 5 :
                           calculations.days_stability >= 90 ? 4 :
                           calculations.days_stability >= 85 ? 3 :
                           calculations.days_stability >= 80 ? 2 : 1;
    
    calculations.milk_loss = inputs.milkTotal > 0 ? (inputs.milkLoss / inputs.milkTotal) * 100 : 0;
    scores.milk_loss = calculations.milk_loss <= 2 ? 5 :
                      calculations.milk_loss <= 5 ? 4 :
                      calculations.milk_loss <= 8 ? 3 :
                      calculations.milk_loss <= 12 ? 2 : 1;
    
    if (state.coopType === 'processing' && inputs.milkProduced > 0) {
        calculations.yield_loss = (inputs.milkLoss / inputs.milkProduced) * 100;
        scores.yield_loss = calculations.yield_loss <= 2 ? 5 :
                           calculations.yield_loss <= 5 ? 4 :
                           calculations.yield_loss <= 8 ? 3 :
                           calculations.yield_loss <= 12 ? 2 : 1;
    } else {
        calculations.yield_loss = 0;
        scores.yield_loss = 0;
    }
    
    calculations.farmer_concentration = inputs.totalFarmerCollection > 0 ? 
        (inputs.top5Farmers / inputs.totalFarmerCollection) * 100 : 0;
    scores.farmer_concentration = calculations.farmer_concentration <= 10 ? 5 :
                                 calculations.farmer_concentration <= 20 ? 4 :
                                 calculations.farmer_concentration <= 30 ? 3 :
                                 calculations.farmer_concentration <= 40 ? 2 : 1;
    
    calculations.collection_stability = inputs.memberLoans > 0 ? 
        (inputs.totalFarmerCollection / inputs.memberLoans) * 100 : 0;
    scores.collection_stability = calculations.collection_stability >= 200 ? 5 :
                                 calculations.collection_stability >= 150 ? 4 :
                                 calculations.collection_stability >= 100 ? 3 :
                                 calculations.collection_stability >= 50 ? 2 : 1;
    
    const avgFarmer = inputs.farmerCount > 0 ? inputs.totalFarmerCollection / inputs.farmerCount : 0;
    calculations.payment_fairness = inputs.highestFarmer > 0 ? 
        (avgFarmer / inputs.highestFarmer) * 100 : 0;
    scores.payment_fairness = calculations.payment_fairness >= 80 ? 5 :
                             calculations.payment_fairness >= 60 ? 4 :
                             calculations.payment_fairness >= 40 ? 3 :
                             calculations.payment_fairness >= 20 ? 2 : 1;
    
    calculations.logistics = (inputs.fleet === 'yes' ? 5 : 0) + (inputs.storage === 'yes' ? 5 : 0);
    scores.logistics = calculations.logistics;
    
    calculations.net_worth = inputs.assets - inputs.liabilities;
    const worthCoverage = inputs.proposedLoan > 0 ? calculations.net_worth / inputs.proposedLoan : 0;
    scores.net_worth = worthCoverage >= 5 ? 5 :
                      worthCoverage >= 3 ? 4 :
                      worthCoverage >= 2 ? 3 :
                      worthCoverage >= 1 ? 2 :
                      calculations.net_worth > 0 ? 1 : 0;
    
    calculations.debt_equity = inputs.equity > 0 ? inputs.totalDebt / inputs.equity : 999;
    scores.debt_equity = calculations.debt_equity <= 0.5 ? 5 :
                        calculations.debt_equity <= 1.0 ? 4 :
                        calculations.debt_equity <= 1.5 ? 3 :
                        calculations.debt_equity <= 2.0 ? 2 : 1;
    
    calculations.current_ratio = inputs.currentLiabilities > 0 ? 
        inputs.currentAssets / inputs.currentLiabilities : 0;
    scores.current_ratio = calculations.current_ratio >= 2.0 ? 5 :
                          calculations.current_ratio >= 1.5 ? 4 :
                          calculations.current_ratio >= 1.25 ? 3 :
                          calculations.current_ratio >= 1.0 ? 2 : 0;
    
    calculations.grant_pct = inputs.revenue > 0 ? (inputs.grantIncome / inputs.revenue) * 100 : 0;
    scores.grant_dependence = calculations.grant_pct <= 5 ? 5 :
                             calculations.grant_pct <= 10 ? 4 :
                             calculations.grant_pct <= 20 ? 3 :
                             calculations.grant_pct <= 30 ? 2 : 1;
    
    calculations.cash_trend = inputs.cashPrev > 0 ? 
        ((inputs.cashLast - inputs.cashPrev) / inputs.cashPrev) * 100 : 0;
    scores.cash_trend = calculations.cash_trend > 10 ? 5 :
                       calculations.cash_trend >= 0 ? 3 :
                       calculations.cash_trend > -10 ? 2 : 1;
    
    calculations.gnpa_pct = inputs.memberLoans > 0 ? (inputs.npaLoans / inputs.memberLoans) * 100 : 0;
    scores.member_gnpa = calculations.gnpa_pct <= 2 ? 5 :
                        calculations.gnpa_pct <= 5 ? 4 :
                        calculations.gnpa_pct <= 10 ? 3 :
                        calculations.gnpa_pct <= 15 ? 2 : 0;
    
    calculations.recovery_pct = inputs.memberLoans > 0 ? 
        (inputs.recoveryMilk / inputs.memberLoans) * 100 : 0;
    scores.recovery_rate = calculations.recovery_pct >= 95 ? 5 :
                          calculations.recovery_pct >= 90 ? 4 :
                          calculations.recovery_pct >= 85 ? 3 :
                          calculations.recovery_pct >= 80 ? 2 : 1;
    
    scores.max_dpd = inputs.maxDpd === 0 ? 5 :
                    inputs.maxDpd <= 5 ? 4 :
                    inputs.maxDpd <= 15 ? 3 :
                    inputs.maxDpd <= 30 ? 2 : 0;
    
    scores.restructuring = inputs.restructures === 0 ? 5 :
                          inputs.restructures === 1 ? 3 : 0;
    
    scores.mgmt_exp = inputs.mgmtExp >= 10 ? 5 :
                     inputs.mgmtExp >= 8 ? 4 :
                     inputs.mgmtExp >= 5 ? 3 :
                     inputs.mgmtExp >= 2 ? 2 : 1;
    
    scores.internal_controls = inputs.internalControls === 'robust' ? 5 :
                              inputs.internalControls === 'adequate' ? 3 : 1;
    
    scores.audit_findings = inputs.auditFindings === 'none' ? 5 :
                           inputs.auditFindings === 'few' ? 4 :
                           inputs.auditFindings === 'some' ? 2 : 1;
    
    scores.lending_compliance = inputs.lendingCompliance === 'yes' ? 5 :
                               inputs.lendingCompliance === 'partial' ? 3 : 0;
    
    if (state.coopType === 'processing') {
        scores.quality_sop = inputs.qualitySop >= 8 ? 5 :
                            inputs.qualitySop >= 6 ? 4 :
                            inputs.qualitySop >= 4 ? 3 :
                            inputs.qualitySop >= 2 ? 2 : 1;
    } else {
        scores.quality_sop = 0;
    }
    
    scores.limit_discipline = inputs.limitDiscipline >= 8 ? 5 :
                             inputs.limitDiscipline >= 6 ? 4 :
                             inputs.limitDiscipline >= 4 ? 3 :
                             inputs.limitDiscipline >= 2 ? 2 : 1;
    
    calculations.bank_sales_pct = inputs.totalSales > 0 ? (inputs.bankSales / inputs.totalSales) * 100 : 0;
    scores.bank_sales_pct = calculations.bank_sales_pct >= 90 ? 5 :
                           calculations.bank_sales_pct >= 75 ? 4 :
                           calculations.bank_sales_pct >= 50 ? 3 :
                           calculations.bank_sales_pct >= 25 ? 2 : 1;
    
    calculations.primary_collateral = inputs.proposedLoan > 0 ? 
        (inputs.collateralPrimary / inputs.proposedLoan) * 100 : 0;
    scores.primary_collateral = calculations.primary_collateral >= 200 ? 5 :
                               calculations.primary_collateral >= 150 ? 4 :
                               calculations.primary_collateral >= 125 ? 3 :
                               calculations.primary_collateral >= 100 ? 2 : 0;
    
    calculations.secondary_collateral = inputs.proposedLoan > 0 ? 
        (inputs.collateralSecondary / inputs.proposedLoan) * 100 : 0;
    scores.secondary_collateral = calculations.secondary_collateral >= 200 ? 5 :
                                 calculations.secondary_collateral >= 150 ? 4 :
                                 calculations.secondary_collateral >= 100 ? 3 :
                                 calculations.secondary_collateral >= 50 ? 2 : 0;
    
    scores.insurance = inputs.insurance === 'yes' ? 5 : 0;
    
    scores.digital_mis = inputs.digital === 'yes' ? 5 :
                        inputs.digital === 'partial' ? 3 : 1;
    
    scores.regulatory = inputs.regulatory === 'full' ? 5 :
                       inputs.regulatory === 'partial' ? 3 : 0;
    
    scores.climate_risk = inputs.climate === 'low' ? 5 :
                         inputs.climate === 'medium' ? 3 : 1;
    
    if (state.customerType === 'existing') {
        scores.credit_history = inputs.creditHistory === 'excellent' ? 5 :
                               inputs.creditHistory === 'good' ? 4 :
                               inputs.creditHistory === 'satisfactory' ? 3 :
                               inputs.creditHistory === 'fair' ? 2 : 0;
        
        const maxDpdBfi = document.getElementById('max_dpd_bfi')?.value || 'timely';
        scores.max_delays = maxDpdBfi === 'timely' ? 5 :
                           maxDpdBfi === 'delay_30' ? 3 :
                           maxDpdBfi === 'delay_60' ? 1 : 0;
    } else {
        scores.credit_history = 0;
        scores.max_delays = 0;
    }
    
    // Calculate Weighted Scores and organize by category
    let totalWeightedScore = 0;
    let maxPossibleScore = 0;
    const results = [];
    state.categoryScores = {};
    
    // Initialize category scores
    for (const cat of Object.keys(categoryWeights)) {
        state.categoryScores[cat] = { score: 0, max: 0, weight: categoryWeights[cat] };
    }
    
    for (const [key, config] of Object.entries(weights)) {
        if ((key === 'yield_loss' || key === 'quality_sop') && state.coopType !== 'processing') continue;
        if ((key === 'credit_history' || key === 'max_delays') && state.customerType !== 'existing') continue;
        
        const score = scores[key] || 0;
        const normalizedScore = (score / config.maxScore) * config.weight;
        totalWeightedScore += normalizedScore;
        maxPossibleScore += config.weight;
        
        if (state.categoryScores[config.category]) {
            state.categoryScores[config.category].score += normalizedScore;
            state.categoryScores[config.category].max += config.weight;
        }
        
        results.push({
            name: config.name,
            category: config.category,
            weight: config.weight,
            rawScore: score,
            maxScore: config.maxScore,
            weightedScore: normalizedScore.toFixed(2),
            calculation: calculations[key] !== undefined ? calculations[key].toFixed(2) : null,
            unit: getUnit(key)
        });
    }
    
    state.finalResults = results;
    displayResults(totalWeightedScore, maxPossibleScore, results);
    generateSynopsis(totalWeightedScore, results);
}

function getUnit(key) {
    const units = {
        dscr: 'ratio',
        seasonality: 'months',
        inventory_days: 'days',
        receivable_days: 'days',
        milk_stability: '%',
        days_stability: '%',
        milk_loss: '%',
        yield_loss: '%',
        farmer_concentration: '%',
        collection_stability: '%',
        payment_fairness: '%',
        logistics: 'score',
        net_worth: 'NPR',
        debt_equity: 'ratio',
        current_ratio: 'ratio',
        grant_dependence: '%',
        cash_trend: '% change',
        member_gnpa: '%',
        recovery_rate: '%',
        primary_collateral: '%',
        secondary_collateral: '%',
        bank_sales_pct: '%'
    };
    return units[key] || '';
}

function generateSynopsis(totalScore, results) {
    const ratingEl = document.getElementById('risk_grade');
    const indicatorEl = document.getElementById('risk_indicator');
    const summaryScoreEl = document.getElementById('summary_score');
    const benchmarkFill = document.getElementById('benchmark_fill');
    const benchmarkText = document.getElementById('benchmark_text');
    
    summaryScoreEl.textContent = totalScore.toFixed(2);
    
    let rating, ratingClass, color;
    if (totalScore >= 75) {
        rating = 'EXCELLENT';
        ratingClass = 'status-excellent';
        color = 'var(--success)';
        indicatorEl.style.background = 'var(--success)';
        benchmarkText.textContent = 'Significantly Above Average';
        benchmarkText.style.color = 'var(--success)';
    } else if (totalScore >= 60) {
        rating = 'GOOD';
        ratingClass = 'status-good';
        color = '#2563eb';
        indicatorEl.style.background = '#2563eb';
        benchmarkText.textContent = 'Above Average';
        benchmarkText.style.color = '#2563eb';
    } else if (totalScore >= 45) {
        rating = 'MODERATE';
        ratingClass = 'status-moderate';
        color = 'var(--warning)';
        indicatorEl.style.background = 'var(--warning)';
        benchmarkText.textContent = 'Average - Caution Advised';
        benchmarkText.style.color = 'var(--warning)';
    } else {
        rating = 'HIGH RISK';
        ratingClass = 'status-poor';
        color = 'var(--danger)';
        indicatorEl.style.background = 'var(--danger)';
        benchmarkText.textContent = 'Below Average - High Risk';
        benchmarkText.style.color = 'var(--danger)';
    }
    
    ratingEl.textContent = rating;
    ratingEl.style.color = color;
    
    // Animate benchmark bar
    setTimeout(() => {
        benchmarkFill.style.width = totalScore + '%';
        benchmarkFill.style.background = color;
        benchmarkFill.textContent = totalScore.toFixed(1) + '%';
    }, 100);
    
    // Generate Category Analysis Cards
    const analysisContainer = document.getElementById('category_analysis');
    analysisContainer.innerHTML = '';
    
    const categoryDescriptions = {
        'Cash Flow & Loan Repayment': 'Ability to service debt from operating cash flows and manage seasonal variations',
        'Milk Supply & Operational Stability': 'Consistency of milk collection, operational continuity, and supply chain efficiency',
        'Financial Strength': 'Balance sheet health, liquidity position, and capital adequacy',
        'Loan Recovery & Member Credit Risk': 'Effectiveness of internal lending operations and recovery mechanisms',
        'Management & Governance': 'Quality of leadership, internal controls, and compliance culture',
        'Operational Quality': 'Adherence to SOPs, quality standards, and financial transparency',
        'Collateral & Security': 'Asset coverage and security strength for the proposed facility',
        'Risk Factors': 'Insurance coverage, digital adoption, regulatory compliance, and external risks',
        'Credit History': 'Historical repayment behavior and banking track record'
    };
    
    for (const [category, data] of Object.entries(state.categoryScores)) {
        if (data.max === 0) continue;
        
        const percentage = (data.score / data.weight) * 100;
        let status, statusClass, cardClass;
        
        if (percentage >= 80) {
            status = 'Strong';
            statusClass = 'status-excellent';
            cardClass = 'good';
        } else if (percentage >= 60) {
            status = 'Adequate';
            statusClass = 'status-good';
            cardClass = 'good';
        } else if (percentage >= 40) {
            status = 'Needs Attention';
            statusClass = 'status-moderate';
            cardClass = 'warning';
        } else {
            status = 'Critical';
            statusClass = 'status-poor';
            cardClass = 'critical';
        }
        
        const card = document.createElement('div');
        card.className = `analysis-card ${cardClass}`;
        card.innerHTML = `
            <div class="analysis-header">
                <div class="analysis-category">${category}</div>
                <div class="analysis-score" style="color: ${percentage >= 60 ? 'var(--success)' : percentage >= 40 ? 'var(--warning)' : 'var(--danger)'}">
                    ${data.score.toFixed(1)}/${data.weight}
                </div>
            </div>
            <span class="analysis-status ${statusClass}">${status}</span>
            <div class="score-bar" style="margin: 10px 0;">
                <div class="score-fill ${percentage < 60 ? 'medium' : ''} ${percentage < 40 ? 'low' : ''}" 
                     style="width: ${percentage}%; background: ${percentage >= 60 ? 'var(--success)' : percentage >= 40 ? 'var(--warning)' : 'var(--danger)'}"></div>
            </div>
            <div class="analysis-details">${categoryDescriptions[category]}</div>
        `;
        analysisContainer.appendChild(card);
    }
    
    // Decision Matrix
    const decisionGrid = document.getElementById('decision_grid');
    decisionGrid.innerHTML = '';
    
    const decisions = [
        { label: 'Recommended Action', value: getRecommendation(totalScore, 'action') },
        { label: 'Risk Level', value: rating },
        { label: 'Loan Tenor', value: totalScore >= 75 ? 'Long Term (5-7 years)' : totalScore >= 60 ? 'Medium Term (3-5 years)' : 'Short Term (1-2 years)' },
        { label: 'Collateral Requirement', value: totalScore >= 75 ? 'Standard (100-125%)' : totalScore >= 60 ? 'Enhanced (125-150%)' : 'Strict (>150%)' },
        { label: 'Review Frequency', value: totalScore >= 75 ? 'Annual' : totalScore >= 60 ? 'Semi-Annual' : 'Quarterly' },
        { label: 'Interest Rate Spread', value: totalScore >= 75 ? 'Base Rate + 1-2%' : totalScore >= 60 ? 'Base Rate + 2-3%' : 'Base Rate + 3-5%' }
    ];
    
    decisions.forEach(d => {
        const item = document.createElement('div');
        item.className = 'decision-item';
        item.innerHTML = `
            <div class="decision-label">${d.label}</div>
            <div class="decision-value" style="font-weight: 700; color: ${totalScore >= 60 ? 'var(--success)' : totalScore >= 45 ? 'var(--warning)' : 'var(--danger)'}">
                ${d.value}
            </div>
        `;
        decisionGrid.appendChild(item);
    });
    
    // Strengths and Weaknesses
    const strengthsList = document.getElementById('strengths_list');
    const weaknessesList = document.getElementById('weaknesses_list');
    strengthsList.innerHTML = '';
    weaknessesList.innerHTML = '';
    
    const strengths = [];
    const weaknesses = [];
    
    // Analyze results for strengths/weaknesses
    results.forEach(r => {
        const pct = (r.rawScore / r.maxScore) * 100;
        if (pct >= 80 && r.weight >= 3) {
            strengths.push(`${r.name}: Strong performance (${r.rawScore}/${r.maxScore})`);
        } else if (pct <= 40 && r.weight >= 3) {
            weaknesses.push(`${r.name}: Requires immediate attention (${r.rawScore}/${r.maxScore})`);
        }
    });
    
    // Add category-level insights
    for (const [cat, data] of Object.entries(state.categoryScores)) {
        if (data.max === 0) continue;
        const pct = (data.score / data.weight) * 100;
        if (pct >= 80) {
            strengths.push(`${cat}: Exceptional category performance (${pct.toFixed(0)}%)`);
        } else if (pct <= 40) {
            weaknesses.push(`${cat}: Critical risk area requiring mitigation (${pct.toFixed(0)}%)`);
        }
    }
    
    if (strengths.length === 0) strengths.push('No outstanding strengths identified - recommend monitoring');
    if (weaknesses.length === 0) weaknesses.push('No critical weaknesses identified - standard monitoring sufficient');
    
    strengths.forEach(s => {
        const li = document.createElement('li');
        li.textContent = s;
        strengthsList.appendChild(li);
    });
    
    weaknesses.forEach(w => {
        const li = document.createElement('li');
        li.textContent = w;
        weaknessesList.appendChild(li);
    });
    
    // Final Recommendation
    const recEl = document.getElementById('final_recommendation');
    recEl.innerHTML = getRecommendation(totalScore, 'detailed');
    
    // Draw charts after a short delay to ensure canvas is visible
    setTimeout(drawCharts, 100);
}

function getRecommendation(score, type) {
    if (type === 'action') {
        if (score >= 75) return 'Approve - Standard Terms';
        if (score >= 60) return 'Approve - With Conditions';
        if (score >= 45) return 'Refer to Credit Committee';
        return 'Decline / Restructure Required';
    }
    
    if (score >= 75) {
        return `<strong>Strong Approval Recommended:</strong> This cooperative demonstrates exceptional creditworthiness across all key metrics. 
                The strong DSCR, stable milk supply, robust governance, and healthy financial ratios indicate capacity to service debt obligations comfortably. 
                <br><br><strong>Key Positive Indicators:</strong> Low leverage, high recovery rates, experienced management, and strong collateral coverage. 
                Recommend approval with standard terms and annual review cycle.`;
    } else if (score >= 60) {
        return `<strong>Approval Recommended with Monitoring:</strong> The cooperative meets minimum credit standards with adequate buffers. 
                While financial performance is satisfactory, identified gaps in <span id="gap_areas">operational efficiency and risk management</span> require attention. 
                <br><br><strong>Conditions:</strong> Quarterly financial reporting, maintenance of minimum liquidity thresholds, and semi-annual site visits recommended. 
                Consider shorter initial tenor with renewal option upon satisfactory performance.`;
    } else if (score >= 45) {
        return `<strong>Conditional Approval / Enhanced Monitoring Required:</strong> Credit application shows moderate risk profile with specific vulnerabilities in cash flow stability and/or governance structures. 
                <br><br><strong>Mitigation Required:</strong> Enhanced collateral (minimum 150%), personal/corporate guarantees, monthly monitoring, and strict covenant compliance. 
                Recommend Credit Committee review and potential phased disbursement linked to milestones.`;
    } else {
        return `<strong>Decline or Restructure Recommended:</strong> Significant credit risks identified including inadequate debt service capacity, high leverage, poor governance, or weak repayment track record. 
                <br><br><strong>Action Required:</strong> If existing borrower, immediate restructuring recommended. If new applicant, decline current proposal and provide specific improvement plan. 
                Reconsider upon demonstration of 12-month sustained improvement in identified weak areas.`;
    }
}

function drawCharts() {
    // Radar Chart
    const radarCanvas = document.getElementById('radarChart');
    if (!radarCanvas) return;
    
    const ctx = radarCanvas.getContext('2d');
    const width = radarCanvas.width;
    const height = radarCanvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 40;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Get categories for radar (max 8 for readability)
    const categories = Object.keys(state.categoryScores).filter(c => state.categoryScores[c].max > 0).slice(0, 8);
    const numCategories = categories.length;
    const angleStep = (Math.PI * 2) / numCategories;
    
    // Draw background grid
    for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        for (let j = 0; j < numCategories; j++) {
            const angle = j * angleStep - Math.PI / 2;
            const r = (radius / 5) * i;
            const x = centerX + Math.cos(angle) * r;
            const y = centerY + Math.sin(angle) * r;
            if (j === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();
    }
    
    // Draw axes
    for (let i = 0; i < numCategories; i++) {
        const angle = i * angleStep - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius);
        ctx.strokeStyle = '#d1d5db';
        ctx.stroke();
        
        // Labels
        const labelRadius = radius + 25;
        const labelX = centerX + Math.cos(angle) * labelRadius;
        const labelY = centerY + Math.sin(angle) * labelRadius;
        ctx.fillStyle = '#374151';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const shortName = categories[i].split(' ').slice(0, 2).join(' ');
        ctx.fillText(shortName, labelX, labelY);
    }
    
    // Draw data
    ctx.beginPath();
    ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    
    categories.forEach((cat, i) => {
        const data = state.categoryScores[cat];
        const percentage = data.score / data.weight;
        const angle = i * angleStep - Math.PI / 2;
        const r = radius * percentage;
        const x = centerX + Math.cos(angle) * r;
        const y = centerY + Math.sin(angle) * r;
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        
        // Draw point
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
    });
    
    ctx.closePath();
    ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
    ctx.fill();
    ctx.stroke();
    
    // Bar Chart
    const barCanvas = document.getElementById('barChart');
    if (!barCanvas) return;
    
    const bCtx = barCanvas.getContext('2d');
    const bWidth = barCanvas.width;
    const bHeight = barCanvas.height;
    const padding = 40;
    const chartHeight = bHeight - 2 * padding;
    const chartWidth = bWidth - 2 * padding;
    
    bCtx.clearRect(0, 0, bWidth, bHeight);
    
    const activeCategories = categories;
    const barWidth = chartWidth / activeCategories.length * 0.6;
    const spacing = chartWidth / activeCategories.length;
    
    // Find max for scaling
    let maxVal = 0;
    activeCategories.forEach(cat => {
        const pct = (state.categoryScores[cat].score / state.categoryScores[cat].weight) * 100;
        if (pct > maxVal) maxVal = pct;
    });
    maxVal = Math.max(maxVal, 100);
    
    activeCategories.forEach((cat, i) => {
        const data = state.categoryScores[cat];
        const percentage = (data.score / data.weight) * 100;
        const barHeight = (percentage / maxVal) * chartHeight;
        const x = padding + i * spacing + (spacing - barWidth) / 2;
        const y = bHeight - padding - barHeight;
        
        // Color based on score
        let color = percentage >= 80 ? '#059669' : percentage >= 60 ? '#2563eb' : percentage >= 40 ? '#d97706' : '#dc2626';
        
        bCtx.fillStyle = color;
        bCtx.fillRect(x, y, barWidth, barHeight);
        
        // Value label
        bCtx.fillStyle = '#1f2937';
        bCtx.font = 'bold 12px sans-serif';
        bCtx.textAlign = 'center';
        bCtx.fillText(percentage.toFixed(0) + '%', x + barWidth / 2, y - 5);
        
        // Category label (rotated)
        bCtx.save();
        bCtx.translate(x + barWidth / 2, bHeight - padding + 15);
        bCtx.rotate(-Math.PI / 6);
        bCtx.fillStyle = '#6b7280';
        bCtx.font = '10px sans-serif';
        const shortLabel = cat.split(' ')[0];
        bCtx.fillText(shortLabel, 0, 0);
        bCtx.restore();
    });
    
    // Y-axis
    bCtx.beginPath();
    bCtx.strokeStyle = '#9ca3af';
    bCtx.moveTo(padding, padding);
    bCtx.lineTo(padding, bHeight - padding);
    bCtx.stroke();
}

function displayResults(total, maxPossible, results) {
    const resultsPanel = document.getElementById('results_panel');
    const totalScoreEl = document.getElementById('total_score');
    const ratingEl = document.getElementById('score_rating');
    const breakdownEl = document.getElementById('calculations_breakdown');
    
    resultsPanel.classList.add('show');
    totalScoreEl.textContent = total.toFixed(2);
    
    let rating, ratingClass;
    if (total >= 75) {
        rating = 'EXCELLENT / ‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü';
        ratingClass = 'score-excellent';
    } else if (total >= 60) {
        rating = 'GOOD / ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã';
        ratingClass = 'score-good';
    } else if (total >= 45) {
        rating = 'MODERATE / ‡§Æ‡§ß‡•ç‡§Ø‡§Æ';
        ratingClass = 'score-average';
    } else {
        rating = 'HIGH RISK / ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ã‡§ñ‡§ø‡§Æ';
        ratingClass = 'score-poor';
    }
    
    ratingEl.textContent = rating;
    ratingEl.className = 'score-badge ' + ratingClass;
    
    // Group results by category
    const categories = [
        { name: 'Cash Flow & Loan Repayment (20%)', keys: ['dscr', 'seasonality', 'inventory_days', 'receivable_days'] },
        { name: 'Milk Supply & Operational Stability (15%)', keys: ['milk_stability', 'days_stability', 'milk_loss', 'yield_loss', 'farmer_concentration', 'collection_stability', 'payment_fairness', 'logistics'] },
        { name: 'Financial Strength (15%)', keys: ['net_worth', 'debt_equity', 'current_ratio', 'grant_dependence', 'cash_trend'] },
        { name: 'Loan Recovery & Member Credit Risk (15%)', keys: ['member_gnpa', 'recovery_rate', 'max_dpd', 'restructuring'] },
        { name: 'Management & Governance (10%)', keys: ['mgmt_exp', 'internal_controls', 'audit_findings', 'lending_compliance'] },
        { name: 'Operational Quality (8%)', keys: ['quality_sop', 'limit_discipline', 'bank_sales_pct'] },
        { name: 'Collateral & Security (7%)', keys: ['primary_collateral', 'secondary_collateral'] },
        { name: 'Risk Factors (5%)', keys: ['insurance', 'digital_mis', 'regulatory', 'climate_risk'] }
    ];
    
    if (state.customerType === 'existing') {
        categories.push({ name: 'Credit History (5%)', keys: ['credit_history', 'max_delays'] });
    }
    
    let html = '';
    
    categories.forEach(cat => {
        const catResults = results.filter(r => cat.keys.includes(Object.keys(weights).find(k => weights[k].name === r.name)));
        if (catResults.length === 0) return;
        
        const catScore = catResults.reduce((sum, r) => sum + parseFloat(r.weightedScore), 0);
        const catMax = catResults.reduce((sum, r) => sum + r.weight, 0);
        
        html += `
            <div style="grid-column: 1/-1; margin-top: 20px; margin-bottom: 10px; padding: 10px; background: #e0e7ff; border-radius: 6px; font-weight: 700; color: var(--primary); display: flex; justify-content: space-between;">
                <span>${cat.name}</span>
                <span>Score: ${catScore.toFixed(2)}/${catMax}</span>
            </div>
        `;
        
        catResults.forEach(metric => {
            const percent = (metric.rawScore / metric.maxScore) * 100;
            const barColor = percent >= 80 ? 'var(--success)' : percent >= 60 ? 'var(--warning)' : 'var(--danger)';
            
            html += `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-name">${metric.name}</div>
                        <div class="metric-value" style="color: ${percent >= 60 ? 'var(--success)' : percent >= 40 ? 'var(--warning)' : 'var(--danger)'}">
                            ${metric.rawScore}/${metric.maxScore}
                        </div>
                    </div>
                    <div class="weight-info">Weight: ${metric.weight} | Calculation: ${metric.calculation !== null ? metric.calculation + ' ' + metric.unit : 'N/A'}</div>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${(metric.weightedScore / metric.weight) * 100}%; background: ${barColor}"></div>
                    </div>
                    <div style="text-align: right; font-size: 0.9em; color: #6b7280; margin-top: 5px;">
                        Weighted: ${metric.weightedScore}
                    </div>
                </div>
            `;
        });
    });
    
    breakdownEl.innerHTML = html;
    
    // Scroll to results
    resultsPanel.scrollIntoView({ behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', () => {
    showTab('basic');
});
</script>

</body>
</html>




